<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>smartLive</title>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
    
  <script type="text/javascript">

 var s = io.connect(); //リモート
  //var s = io.connect('http://localhost:3000'); //ローカル

  //サーバから受け取るイベント
  s.on("connect", function () {});  // 接続時
  s.on("disconnect", function (client) {});  // 切断時
  s.on("S_to_C_message", function (data) {
    addMessage(data.value);
  });
//ここから変数


//var msg=new Array[3];

  //クライアントからイベント送信（イベント名は自由に設定できます）
  function sendMessage(c_1,c_2,c_3) {
    
	msg=c_1;
	//var msg= new Array(3);
	//msg[0] = c_1;
//msg[1] = c_2;
//msg[2] = c_3;
	//var msg = $("#message").val(); //取得
    //$("#message").val(""); //空白にする
    s.emit("C_to_S_message", {value:msg}); //サーバへ送信
  }
  
  function sendText() {
    //var txt=t1;
	//var msg= new Array(3);
	//msg[0] = c_1;
//msg[1] = c_2;
//msg[2] = c_3;

	//var txt = $("#message").val(); //取得
	//msg[1] =txt;
    //$("#message").val(""); //空白にする
   // s.emit("C_to_S_message", {value:msg[1]}); //サーバへ送信
  }
   

  function sendBroadcast() {
    var msg = $("#message").val(); //取得
    $("#message").val(""); //空白にする
    s.emit("C_to_S_broadcast", {value:msg}); // サーバへ送信
  }

  //jqueryでメッセージを追加
  function addMessage (value,color,size) {
	  var comp=value
    var msg = comp//.replace( /[!@$%<>'"&|]/g, '' ); //タグ記号とかいくつか削除
	//var t1=comp[1].replace( /[!@$%<>'"&|]/g, '' ); //タグ記号とかいくつか削除
    //ログの書き出し
	//$("#msg_list").prepend("<p class='msg'>text:" + t1+ "</p>");
	$("#msg_list").prepend("<p class='msg'>msg:" + msg+ "</p>");
	$("#sp_bg,#sc_bg").css({"backgroundColor":''+msg});
	//$("#scr_1").css({"opacity":msg[0]});
	//$("#scr_2").css({"opacity":msg[1]})
	//$("#scr_3").css({"opacity":msg[2]})
  }    




  </script>
   <script type="text/javascript">
   
   // JavaScript Document
{
	var m=null;
	var inputs=null;
	var input=null;
	var input_device=0;
	var input_menu_id=null;
	
//Midi API 判定
	function runTest(){navigator.requestMIDIAccess().then( success, failure );}
	function success(midiAccess)
	{
		m=midiAccess;
		inputs=m.inputs();
		setInputDeviceSelect();
	}
	function failure(error){alert( "NG" )}
//インプットデバイス	
	function setInputMenuID(parts){
		input_menu_id = parts;
	}
	function setInputDeviceSelect(){
		var i=0;
		if(m!=null){
			if(inputs.length>0){
				for(i=0; i<inputs.length; i++)
					input_menu_id.options[i+1] = new Option(inputs[i].name, i+1);
			}
		} 
	}

	function inputDeviceSelect(item){
		input_device = item.options[item.selectedIndex].value-1;
		if(input_device==-1) input_device=0;
		input= inputs[input_device];			
		input.onmidimessage = handleMIDIMessage1; 
	}

	
//イベント処理
//function raw_event(){
	
//	var raw_str ="<tr><td>" +event.data[1]+ "</td><td>|</td><td>" +event.data[2]+ " </td><td>|</td><td>" +event.data[0] +"</td></tr>\n";
//		$('table#rawlog').prepend(raw_str)
	
//	}
	
function change_bg(){
	if(event.data[1]==0)
	{ch_1=parseInt(event.data[2])/127*100+"%";
	}
	if(event.data[1]==1)
	{ch_2=parseInt(event.data[2])/127*100+"%";}
	if(event.data[1]==2)
	{ch_3=parseInt(event.data[2])/127*100+"%";}
	sendMessage(ch_1,ch_2,ch_3);
	$('body').css({"backgroundColor":"rgb("+ch_r+","+ch_g+","+ch_b+")"})
	//
	//var str2 ="<tr><td>" + ch_r+ "</td><td>|</td><td>"+ch_g+"</td><td>|</td><td>"+ch_b+"</td></tr>\n";
	//$('table#log').prepend(str2);
	}
	function handleMIDIMessage1( event ) {
		//
		//raw_event()
		change_bg()
		//ノートオンオフ判定
		
		
		
			//
		

		
	}
}
</script>
<!--SP用JS読み込み-->
<script src="./js_core/sp.js"></script>
<link rel="stylesheet" type="text/css" href="./css/sp.css">
</head>
<body>
<div id="monitor_sp">
<div id="sp_bg"></div>
<canvas id="canvas_sp1"></canvas>
<canvas id="canvas_sp2"></canvas>
</div>
<script>
runTest()</script>
<div id="pre"><h6>CONNECTING</h6></div>
</body>
</html>